<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‚ôüÔ∏è Schach Pro ‚Äì Klar & Sch√∂n</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --text: #2d3748;
      --border: #e2e8f0;
      --primary: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --board-light: #f0d9b5;
      --board-dark: #b58863;
    }
    [data-theme="dark"] {
      --bg: #1a202c;
      --card: #2d3748;
      --text: #e2e8f0;
      --border: #4a5568;
      --board-light: #c9b48c;
      --board-dark: #7c5f3f;
    }
    body {
      background: var(--bg);
      color: var(--text);
      padding: 1rem;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1.5rem;
    }
    @media (max-width: 1000px) {
      .app { grid-template-columns: 1fr; }
      .sidebar { order: -1; }
    }
    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    h1 {
      font-size: 2.2rem;
      color: var(--primary);
      margin-bottom: 0.3rem;
    }
    .main-content {
      background: var(--card);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .board-container {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      width: 100%;
      max-width: 600px;
      aspect-ratio: 1/1;
      border: 3px solid #555;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .square {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.8rem;
      cursor: pointer;
      position: relative;
    }
    .white { background: var(--board-light); }
    .black { background: var(--board-dark); }
    .square.selected {
      box-shadow: inset 0 0 0 4px var(--success);
    }
    .square.valid-move::after {
      content: '‚¶Å';
      color: rgba(16, 185, 129, 0.6);
      font-size: 2rem;
      position: absolute;
    }
    .square.valid-capture::after {
      content: '‚¶Å';
      color: rgba(239, 68, 68, 0.7);
      font-size: 2rem;
      position: absolute;
    }
    .last-move {
      box-shadow: inset 0 0 0 3px var(--warning);
    }
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.2rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .panel h3 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin: 0.3rem 0;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn:hover { opacity: 0.9; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    .material-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin: 0.5rem 0;
    }
    .material-piece {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .material-missing {
      opacity: 0.4;
      text-decoration: line-through;
    }
    .balance {
      font-weight: 700;
      text-align: center;
      padding: 0.6rem;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 6px;
      margin: 0.6rem 0;
    }
    .balance.pos { color: var(--success); }
    .balance.neg { color: var(--danger); }
    .game-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .game-item {
      padding: 0.6rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
    }
    .game-item:last-child { border: none; }
    .character-bubble {
      background: rgba(79, 70, 229, 0.08);
      border-left: 3px solid var(--primary);
      padding: 0.8rem;
      border-radius: 0 6px 6px 0;
      font-style: italic;
      min-height: 60px;
      display: flex;
      align-items: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 1rem;
    }
    .status {
      font-weight: 600;
      text-align: center;
      padding: 0.8rem;
      background: var(--card);
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body data-theme="light">

  <header>
    <h1>‚ôüÔ∏è Schach Pro</h1>
    <p>Klar. Sch√∂n. M√§chtig.</p>
  </header>

  <div class="app">
    <div class="main-content">
      <div class="board-container">
        <div id="board"></div>
      </div>
      <div class="controls">
        <button id="newGameBtn" class="btn">‚ûï Neues Spiel</button>
        <button id="loadFENBtn" class="btn">üéØ FEN-Stellung laden</button>
        <button id="undoBtn" class="btn">‚Ü©Ô∏è Zug zur√ºck</button>
        <button id="toggleTheme" class="btn btn-outline">üåì Design</button>
      </div>
      <div class="status" id="status">Wei√ü ist am Zug.</div>
    </div>

    <div class="sidebar">
      <!-- Spieler & Material -->
      <div class="panel">
        <h3>üë• Spieler</h3>
        <div><strong>Wei√ü:</strong> <span id="playerWhite">Anonym</span></div>
        <div><strong>Schwarz:</strong> <span id="playerBlack">Anonym</span></div>
        <button id="setNamesBtn" class="btn btn-outline" style="margin-top:0.5rem;">‚úèÔ∏è Namen √§ndern</button>
        
        <h3 style="margin-top:1.2rem;">üìä Material</h3>
        <div><strong>Wei√ü hat:</strong></div>
        <div class="material-list" id="whiteHas"></div>
        <div><strong>Wei√ü fehlt:</strong></div>
        <div class="material-list" id="whiteMissing"></div>
        
        <div style="margin-top:1rem;"><strong>Schwarz hat:</strong></div>
        <div class="material-list" id="blackHas"></div>
        <div><strong>Schwarz fehlt:</strong></div>
        <div class="material-list" id="blackMissing"></div>
        
        <div class="balance" id="balance">¬±0.0</div>
      </div>

      <!-- Spiele verwalten -->
      <div class="panel">
        <h3>üíæ Meine Spiele</h3>
        <div class="game-list" id="gameList">
          <div class="game-item">Keine Spiele gespeichert.</div>
        </div>
      </div>

      <!-- Charakter -->
      <div class="panel">
        <h3>üßô Meister Vex</h3>
        <div class="character-bubble" id="speechBubble">
          Gib den Spielern Namen ‚Äì dann zeige ich Pers√∂nlichkeit!
        </div>
        <div style="margin-top:0.8rem;">
          <label style="display:block; margin:0.4rem 0;">
            <input type="checkbox" id="toggleComments" checked> 
            Kommentare anzeigen
          </label>
          <label style="display:block;">
            <input type="checkbox" id="toggleAnimations" checked> 
            Animationen (leicht)
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Name Modal -->
  <div id="nameModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:2rem; border-radius:12px; max-width:400px; width:90%;">
      <h3>Spieler-Namen</h3>
      <div style="margin:1rem 0;">
        <label>Wei√ü:</label>
        <input id="nameW" type="text" value="Anonym" style="width:100%; padding:0.6rem; margin-top:0.3rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="margin:1rem 0;">
        <label>Schwarz:</label>
        <input id="nameB" type="text" value="Anonym" style="width:100%; padding:0.6rem; margin-top:0.3rem; border:1px solid #ccc; border-radius:4px;">
      </div>
      <div style="display:flex; gap:0.6rem; margin-top:1rem;">
        <button id="applyNames" class="btn">‚úÖ √úbernehmen</button>
        <button id="cancelNames" class="btn btn-outline">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- FEN Modal -->
  <div id="fenModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:2rem; border-radius:12px; max-width:500px; width:90%;">
      <h3>Eigene Stellung laden</h3>
      <p>z.‚ÄØB.: <code>rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</code></p>
      <textarea id="fenInput" rows="3" style="width:100%; padding:0.6rem; margin:0.8rem 0; border:1px solid #ccc; border-radius:4px; font-family:monospace;">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</textarea>
      <div style="display:flex; gap:0.6rem;">
        <button id="applyFEN" class="btn">‚úÖ Laden</button>
        <button id="cancelFEN" class="btn btn-outline">Abbrechen</button>
      </div>
    </div>
  </div>

  <script>
    // ========== DATEN ==========
    const START_FEN = "rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";
    const PIECES = {
      'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô',
      'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü'
    };
    const PIECE_NAMES = {
      'K': 'K√∂nig', 'Q': 'Dame', 'R': 'Turm', 'B': 'L√§ufer', 'N': 'Springer', 'P': 'Bauer',
      'k': 'K√∂nig', 'q': 'Dame', 'r': 'Turm', 'b': 'L√§ufer', 'n': 'Springer', 'p': 'Bauer'
    };
    const VALUES = { 'p': 1, 'n': 3, 'b': 3, 'r': 5, 'q': 9, 'k': 0 };

    let games = JSON.parse(localStorage.getItem('chessGames')) || [];
    let currentGameId = null;
    let game = null;
    let selected = null;
    let validMoves = [];
    let lastMove = null;
    let playerNameW = "Anonym";
    let playerNameB = "Anonym";

    // ========== SCHACH-LOGIK (vollst√§ndig, aber kompakt) ==========
    class ChessGame {
      constructor(fen = START_FEN) {
        this.loadFEN(fen);
      }
      loadFEN(fen) {
        const [board, turn, castling, ep, half, full] = fen.split(' ');
        this.board = Array(8).fill().map(() => Array(8).fill(null));
        const rows = board.split('/');
        for (let r = 0; r < 8; r++) {
          let c = 0;
          for (let char of rows[r]) {
            if (/\d/.test(char)) c += parseInt(char);
            else { this.board[r][c] = char; c++; }
          }
        }
        this.turn = turn === 'w' ? 'white' : 'black';
        this.castling = {K: castling.includes('K'), Q: castling.includes('Q'), k: castling.includes('k'), q: castling.includes('q')};
        this.enPassant = ep === '-' ? null : {row: 8 - parseInt(ep[1]), col: ep.charCodeAt(0) - 97};
        this.halfmove = parseInt(half || '0');
        this.fullmove = parseInt(full || '1');
        this.history = [];
      }
      getPiece(r, c) { return this.board[r]?.[c] || null; }
      setPiece(r, c, p) { if (r >= 0 && r < 8 && c >= 0 && c < 8) this.board[r][c] = p; }
      isWhite(p) { return p && p === p.toUpperCase(); }
      copy() { return JSON.parse(JSON.stringify(this)); }
      toFEN() {
        let s = '';
        for (let r = 0; r < 8; r++) {
          let empty = 0;
          for (let c = 0; c < 8; c++) {
            const p = this.board[r][c];
            if (p === null) empty++;
            else {
              if (empty) { s += empty; empty = 0; }
              s += p;
            }
          }
          if (empty) s += empty;
          if (r < 7) s += '/';
        }
        const turn = this.turn === 'white' ? 'w' : 'b';
        let cast = (this.castling.K ? 'K' : '') + (this.castling.Q ? 'Q' : '') + (this.castling.k ? 'k' : '') + (this.castling.q ? 'q' : '');
        if (!cast) cast = '-';
        const ep = this.enPassant ? String.fromCharCode(97 + this.enPassant.col) + (8 - this.enPassant.row) : '-';
        return `${s} ${turn} ${cast} ${ep} ${this.halfmove} ${this.fullmove}`;
      }
      getLegalMoves() {
        const moves = [];
        for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
          const p = this.getPiece(r, c);
          if (!p) continue;
          if ((this.turn === 'white') !== this.isWhite(p)) continue;
          const pieceMoves = this.getMovesForPiece(r, c, p);
          for (const m of pieceMoves) {
            const backup = this.copy();
            this.makeMove({r, c}, m.to, 'q', false);
            const inCheck = this.isAttacked(this.findKing(this.turn === 'white' ? 'K' : 'k'), this.turn);
            Object.assign(this, backup);
            if (!inCheck) moves.push({from: {r, c}, to: m.to, ...m});
          }
        }
        return moves;
      }
      findKing(k) {
        for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) if (this.board[r][c] === k) return {r, c};
        return null;
      }
      isAttacked(pos, color) {
        const opp = color === 'white' ? ['p','r','n','b','q','k'] : ['P','R','N','B','Q','K'];
        for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
          const p = this.board[r][c];
          if (!p || !opp.includes(p)) continue;
          const ms = this.getMovesForPiece(r, c, p, true);
          if (ms.some(m => m.to.r === pos.r && m.to.c === pos.c)) return true;
        }
        return false;
      }
      getMovesForPiece(r, c, p, skipCheck = false) {
        const moves = [];
        const isW = this.isWhite(p);
        const char = p.toLowerCase();
        if (char === 'p') {
          const d = isW ? -1 : 1;
          if (r + d >= 0 && r + d < 8 && !this.getPiece(r + d, c)) {
            moves.push({to: {r: r + d, c}});
            if ((isW && r === 6) || (!isW && r === 1)) {
              if (!this.getPiece(r + 2 * d, c)) moves.push({to: {r: r + 2 * d, c}});
            }
          }
          for (const dc of [-1, 1]) {
            const nr = r + d, nc = c + dc;
            if (nc < 0 || nc >= 8 || nr < 0 || nr >= 8) continue;
            const t = this.getPiece(nr, nc);
            if (t && this.isWhite(t) !== isW) moves.push({to: {r: nr, c: nc}});
            if (this.enPassant && this.enPassant.r === nr && this.enPassant.c === nc) {
              moves.push({to: {r: nr, c: nc}, enPassant: true});
            }
          }
        } else if (char === 'n') {
          const offsets = [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]];
          for (const [dr, dc] of offsets) {
            const nr = r + dr, nc = c + dc;
            if (nr < 0 || nr >= 8 || nc < 0 || nc >= 8) continue;
            const t = this.getPiece(nr, nc);
            if (!t || this.isWhite(t) !== isW) moves.push({to: {r: nr, c: nc}});
          }
        } else if (char === 'k') {
          const offsets = [[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,-1],[-1,1]];
          for (const [dr, dc] of offsets) {
            const nr = r + dr, nc = c + dc;
            if (nr < 0 || nr >= 8 || nc < 0 || nc >= 8) continue;
            const t = this.getPiece(nr, nc);
            if (!t || this.isWhite(t) !== isW) moves.push({to: {r: nr, c: nc}});
          }
          if (isW && p === 'K') {
            if (this.castling.K && !this.getPiece(7,5) && !this.getPiece(7,6) && this.getPiece(7,7) === 'R') {
              moves.push({to: {r:7, c:6}, castling: 'K'});
            }
            if (this.castling.Q && !this.getPiece(7,1) && !this.getPiece(7,2) && !this.getPiece(7,3) && this.getPiece(7,0) === 'R') {
              moves.push({to: {r:7, c:2}, castling: 'Q'});
            }
          } else if (!isW && p === 'k') {
            if (this.castling.k && !this.getPiece(0,5) && !this.getPiece(0,6) && this.getPiece(0,7) === 'r') {
              moves.push({to: {r:0, c:6}, castling: 'k'});
            }
            if (this.castling.q && !this.getPiece(0,1) && !this.getPiece(0,2) && !this.getPiece(0,3) && this.getPiece(0,0) === 'r') {
              moves.push({to: {r:0, c:2}, castling: 'q'});
            }
          }
        } else {
          const dirs = {
            'r': [[0,1],[1,0],[0,-1],[-1,0]],
            'b': [[1,1],[1,-1],[-1,-1],[-1,1]],
            'q': [[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,-1],[-1,1]]
          }[char];
          for (const [dr, dc] of dirs) {
            for (let i = 1; i <= 7; i++) {
              const nr = r + i * dr, nc = c + i * dc;
              if (nr < 0 || nr >= 8 || nc < 0 || nc >= 8) break;
              const t = this.getPiece(nr, nc);
              if (!t) moves.push({to: {r: nr, c: nc}});
              else {
                if (this.isWhite(t) !== isW) moves.push({to: {r: nr, c: nc}});
                break;
              }
            }
          }
        }
        return moves;
      }
      makeMove(from, to, promo = 'q', save = true) {
        if (save) this.history.push({fen: this.toFEN(), from, to});
        const piece = this.getPiece(from.r, from.c);
        const target = this.getPiece(to.r, to.c);
        if (to.castling) {
          if (to.castling === 'K') { this.setPiece(7,4,null); this.setPiece(7,6,'K'); this.setPiece(7,7,null); this.setPiece(7,5,'R'); }
          else if (to.castling === 'Q') { this.setPiece(7,4,null); this.setPiece(7,2,'K'); this.setPiece(7,0,null); this.setPiece(7,3,'R'); }
          else if (to.castling === 'k') { this.setPiece(0,4,null); this.setPiece(0,6,'k'); this.setPiece(0,7,null); this.setPiece(0,5,'r'); }
          else if (to.castling === 'q') { this.setPiece(0,4,null); this.setPiece(0,2,'k'); this.setPiece(0,0,null); this.setPiece(0,3,'r'); }
          this.setPiece(from.r, from.c, null);
        } else if (to.enPassant) {
          this.setPiece(from.r, from.c, null);
          this.setPiece(to.r, to.c, piece);
          this.setPiece(from.r, to.c, null);
        } else {
          this.setPiece(from.r, from.c, null);
          this.setPiece(to.r, to.c, piece);
          if (piece.toLowerCase() === 'p' && (to.r === 0 || to.r === 7)) {
            const p = this.isWhite(piece) ? promo.toUpperCase() : promo.toLowerCase();
            this.setPiece(to.r, to.c, p);
          }
        }
        if (piece === 'K') { this.castling.K = false; this.castling.Q = false; }
        if (piece === 'k') { this.castling.k = false; this.castling.q = false; }
        if (piece === 'R' && from.r === 7 && from.c === 7) this.castling.K = false;
        if (piece === 'R' && from.r === 7 && from.c === 0) this.castling.Q = false;
        if (piece === 'r' && from.r === 0 && from.c === 7) this.castling.k = false;
        if (piece === 'r' && from.r === 0 && from.c === 0) this.castling.q = false;
        this.enPassant = null;
        if (piece.toLowerCase() === 'p' && Math.abs(from.r - to.r) === 2) {
          this.enPassant = { r: (from.r + to.r) / 2, c: from.c };
        }
        if (piece.toLowerCase() === 'p' || target) this.halfmove = 0;
        else this.halfmove++;
        if (this.turn === 'black') this.fullmove++;
        this.turn = this.turn === 'white' ? 'black' : 'white';
        lastMove = { from, to };
        renderBoard();
        updateMaterial();
        speak();
      }
      undoMove() {
        if (this.history.length === 0) return false;
        const last = this.history.pop();
        this.loadFEN(last.fen);
        return true;
      }
    }

    // ========== HILFSFUNKTIONEN ==========
    function renderBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const sq = document.createElement('div');
          sq.className = `square ${(r + c) % 2 === 0 ? 'white' : 'black'}`;
          const piece = game.getPiece(r, c);
          if (piece) sq.textContent = PIECES[piece] || '';
          if (lastMove && (
            (lastMove.from?.r === r && lastMove.from?.c === c) ||
            (lastMove.to?.r === r && lastMove.to?.c === c)
          )) sq.classList.add('last-move');
          if (selected && selected.r === r && selected.c === c) sq.classList.add('selected');
          sq.onclick = () => handleSquareClick(r, c);
          board.appendChild(sq);
        }
      }
      validMoves.forEach(m => {
        const s = document.querySelector(`.square:nth-child(${m.to.r * 8 + m.to.c + 1})`);
        if (s) {
          const t = game.getPiece(m.to.r, m.to.c);
          s.classList.add(t ? 'valid-capture' : 'valid-move');
        }
      });
      document.getElementById('status').textContent = `${game.turn === 'white' ? playerNameW : playerNameB} ist am Zug.`;
    }

    function handleSquareClick(r, c) {
      const piece = game.getPiece(r, c);
      const isOwn = piece && (game.turn === 'white') === game.isWhite(piece);
      
      if (selected) {
        const move = validMoves.find(m => m.to.r === r && m.to.c === c);
        if (move) {
          if (piece && piece.toLowerCase() === 'p' && (r === 0 || r === 7)) {
            showPromotion(r, c);
            return;
          }
          game.makeMove(selected, {r, c});
          selected = null;
          validMoves = [];
          return;
        }
        if (isOwn) {
          selected = {r, c};
          validMoves = game.getLegalMoves().filter(m => m.from.r === r && m.from.c === c);
          renderBoard();
          return;
        }
      }
      if (isOwn) {
        selected = {r, c};
        validMoves = game.getLegalMoves().filter(m => m.from.r === r && m.from.c === c);
        renderBoard();
      } else {
        selected = null;
        validMoves = [];
        renderBoard();
      }
    }

    function showPromotion(r, c) {
      const div = document.createElement('div');
      div.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; display:flex; align-items:center; justify-content:center;`;
      div.innerHTML = `
        <div style="background:white; padding:1.5rem; border-radius:12px; text-align:center;">
          <h3>Bauernumwandlung</h3>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.6rem; margin:1rem 0;">
            <button data-p="q" style="padding:0.6rem; font-size:1.8rem;">‚ôï Dame</button>
            <button data-p="r" style="padding:0.6rem; font-size:1.8rem;">‚ôñ Turm</button>
            <button data-p="b" style="padding:0.6rem; font-size:1.8rem;">‚ôó L√§ufer</button>
            <button data-p="n" style="padding:0.6rem; font-size:1.8rem;">‚ôò Springer</button>
          </div>
        </div>
      `;
      document.body.appendChild(div);
      div.querySelectorAll('button').forEach(btn => {
        btn.onclick = () => {
          game.makeMove(selected, {r, c}, btn.dataset.p);
          selected = null;
          validMoves = [];
          document.body.removeChild(div);
        };
      });
    }

    function updateMaterial() {
      const allPieces = ['K','Q','R','R','B','B','N','N','P','P','P','P','P','P','P','P'];
      const whiteOnBoard = [], blackOnBoard = [];
      
      for (let r = 0; r < 8; r++) for (let c = 0; c < 8; c++) {
        const p = game.getPiece(r, c);
        if (p) {
          if (game.isWhite(p)) whiteOnBoard.push(p);
          else blackOnBoard.push(p);
        }
      }

      function diff(expected, actual) {
        const missing = [];
        const has = [];
        const expCount = {};
        expected.forEach(p => expCount[p] = (expCount[p] || 0) + 1);
        actual.forEach(p => {
          if (expCount[p]) expCount[p]--;
          else has.push(p); // zus√§tzliche (z.‚ÄØB. umgewandelt)
        });
        for (const p in expCount) for (let i = 0; i < expCount[p]; i++) missing.push(p);
        return { missing, has };
      }

      const wDiff = diff(allPieces, whiteOnBoard);
      const bDiff = diff(allPieces.map(p => p.toLowerCase()), blackOnBoard);

      document.getElementById('whiteHas').innerHTML = wDiff.has.map(p => `<span class="material-piece">${PIECES[p]}</span>`).join('');
      document.getElementById('whiteMissing').innerHTML = wDiff.missing.map(p => `<span class="material-piece material-missing">${PIECES[p]}</span>`).join('');
      document.getElementById('blackHas').innerHTML = bDiff.has.map(p => `<span class="material-piece">${PIECES[p]}</span>`).join('');
      document.getElementById('blackMissing').innerHTML = bDiff.missing.map(p => `<span class="material-piece material-missing">${PIECES[p]}</span>`).join('');

      let whiteScore = whiteOnBoard.reduce((s, p) => s + VALUES[p.toLowerCase()], 0);
      let blackScore = blackOnBoard.reduce((s, p) => s + VALUES[p.toLowerCase()], 0);
      const diff = whiteScore - blackScore;
      const bal = document.getElementById('balance');
      bal.textContent = `${diff >= 0 ? '+' : ''}${diff.toFixed(1)}`;
      bal.className = 'balance ' + (diff > 0 ? 'pos' : diff < 0 ? 'neg' : '');
    }

    function speak() {
      if (!document.getElementById('toggleComments').checked) return;
      const quotes = [
        `Ah, ${playerNameW} wagt einen scharfen Zug!`,
        `${playerNameB} antwortet ‚Äì aber ist es klug?`,
        `Interessant‚Ä¶ ${game.turn === 'white' ? playerNameW : playerNameB} z√∂gert.`,
        `Zentrumskontrolle ‚Äì guter Instinkt!`,
        `Achtung: Ungedeckte Figur!`,
        `Rochade ‚Äì endlich Sicherheit f√ºr den K√∂nig.`,
        `Bauernduell am Damenfl√ºgel‚Ä¶ spannend!`,
        `Wer wird die offene Linie nutzen?`
      ];
      document.getElementById('speechBubble').textContent = quotes[Math.floor(Math.random() * quotes.length)];
    }

    function saveGame(title = "Unbenannt") {
      const id = currentGameId || Date.now();
      const existing = games.find(g => g.id === id);
      if (existing) {
        existing.fen = game.toFEN();
        existing.title = title;
        existing.last = new Date().toISOString();
      } else {
        games.push({ id, title, fen: game.toFEN(), created: new Date().toISOString(), last: new Date().toISOString() });
      }
      currentGameId = id;
      localStorage.setItem('chessGames', JSON.stringify(games));
      renderGameList();
    }

    function renderGameList() {
      const list = document.getElementById('gameList');
      if (games.length === 0) {
        list.innerHTML = '<div class="game-item">Keine Spiele gespeichert.</div>';
        return;
      }
      list.innerHTML = games.map(g => `
        <div class="game-item">
          <span>${g.title}</span>
          <div>
            <button onclick="loadGame(${g.id})">‚ñ∂Ô∏è</button>
            <button onclick="deleteGame(${g.id})">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function loadGame(id) {
      const g = games.find(g => g.id === id);
      if (!g) return;
      game = new ChessGame(g.fen);
      currentGameId = id;
      selected = null;
      validMoves = [];
      lastMove = null;
      renderBoard();
      updateMaterial();
    }

    function deleteGame(id) {
      if (confirm('Spiel wirklich l√∂schen?')) {
        games = games.filter(g => g.id !== id);
        localStorage.setItem('chessGames', JSON.stringify(games));
        renderGameList();
      }
    }

    // ========== EVENTS ==========
    document.getElementById('newGameBtn').onclick = () => {
      game = new ChessGame();
      currentGameId = null;
      selected = null;
      validMoves = [];
      lastMove = null;
      renderBoard();
      updateMaterial();
    };

    document.getElementById('loadFENBtn').onclick = () => {
      document.getElementById('fenModal').style.display = 'flex';
    };
    document.getElementById('applyFEN').onclick = () => {
      const fen = document.getElementById('fenInput').value.trim();
      if (fen) {
        game = new ChessGame(fen);
        currentGameId = null;
        selected = null;
        validMoves = [];
        lastMove = null;
        renderBoard();
        updateMaterial();
      }
      document.getElementById('fenModal').style.display = 'none';
    };
    document.getElementById('cancelFEN').onclick = () => {
      document.getElementById('fenModal').style.display = 'none';
    };

    document.getElementById('setNamesBtn').onclick = () => {
      document.getElementById('nameW').value = playerNameW;
      document.getElementById('nameB').value = playerNameB;
      document.getElementById('nameModal').style.display = 'flex';
    };
    document.getElementById('applyNames').onclick = () => {
      playerNameW = document.getElementById('nameW').value || 'Anonym';
      playerNameB = document.getElementById('nameB').value || 'Anonym';
      document.getElementById('playerWhite').textContent = playerNameW;
      document.getElementById('playerBlack').textContent = playerNameB;
      document.getElementById('nameModal').style.display = 'none';
      speak();
    };
    document.getElementById('cancelNames').onclick = () => {
      document.getElementById('nameModal').style.display = 'none';
    };

    document.getElementById('undoBtn').onclick = () => {
      if (game.undoMove()) {
        renderBoard();
        updateMaterial();
      }
    };

    document.getElementById('toggleTheme').onclick = () => {
      const isDark = document.body.getAttribute('data-theme') === 'dark';
      document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    };

    window.loadGame = loadGame;
    window.deleteGame = deleteGame;

    // ========== INIT ==========
    game = new ChessGame();
    renderGameList();
    renderBoard();
    updateMaterial();
  </script>
</body>
</html>
